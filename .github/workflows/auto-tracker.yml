name: Auto-Track Issues and Welcome Contributors

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened]

permissions:
  issues: write
  pull-requests: write

jobs:
  welcome-and-track:
    runs-on: ubuntu-latest
    if: github.event.sender.login != 'github-actions[bot]'
    steps:
      - name: Welcome New Issue and Guide Contributors
        if: github.event_name == 'issues'
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const author = issue.user.login;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Check if this is a first-time contributor
            const userIssues = await github.rest.issues.listForRepo({
              owner, repo,
              creator: author,
              state: 'all',
              per_page: 5
            });

            const isFirstTimer = userIssues.data.length <= 1;

            // Determine issue difficulty from labels
            const labels = issue.labels.map(l => l.name.toLowerCase());
            const isBeginner = labels.some(l => 
              l.includes('beginner') || l.includes('good first') || l.includes('easy')
            );

            let welcomeSection = '';
            if (isFirstTimer) {
              welcomeSection = `
            ### ðŸŽ‰ Welcome, @${author}!
            This appears to be your first issue in this repository. We're excited to have you!

            **Quick Start:**
            - ðŸ“– Read our [Contributing Guide](CONTRIBUTING.md)
            - ðŸ’¬ Join discussions in the comments
            - ðŸ†˜ Need help? Just ask!
            `;
            }

            const comment = `
            ## ðŸ¤ Community Coordination
            ${welcomeSection}
            **Issue #${issue.number}**: ${issue.title}

            ### ðŸ“Œ How to Claim This Issue:
            Simply comment \`/assign\` to assign yourself!

            ### ðŸ“Š Current Status:
            | Field | Value |
            |-------|-------|
            | Assignee | ${issue.assignees.length > 0 ? issue.assignees.map(a => '@' + a.login).join(', ') : '_Unassigned_'} |
            | Labels | ${issue.labels.length > 0 ? issue.labels.map(l => '`' + l.name + '`').join(', ') : '_None_'} |

            ### ðŸ’¡ Available Commands:
            - \`/assign\` - Claim this issue
            - \`/unassign\` - Release this issue
            - \`/status\` - Check your current assignments

            ---
            _This is an automated message. Happy contributing! ðŸš€_
            `;

            await github.rest.issues.createComment({
              owner, repo,
              issue_number: issue.number,
              body: comment
            });

      - name: Welcome First-Time PR Contributors
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;
            const author = pr.user.login;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Check if this is a first-time PR contributor
            const userPRs = await github.rest.pulls.list({
              owner, repo,
              state: 'all',
              per_page: 5
            });

            const authorPRs = userPRs.data.filter(p => p.user.login === author);
            const isFirstPR = authorPRs.length <= 1;

            if (isFirstPR) {
              await github.rest.issues.createComment({
                owner, repo,
                issue_number: pr.number,
                body: `## ðŸŽ‰ Welcome, @${author}!

            Thank you for your **first pull request** to this project! We really appreciate your contribution.

            **What happens next:**
            1. A maintainer will review your PR
            2. They may request changes or ask questions
            3. Once approved, your PR will be merged!

            **Tips:**
            - Make sure your PR description explains what you changed
            - Link any related issues using "Closes #123"
            - Be patient - reviews may take a few days

            Thanks for being part of our community! ðŸ’œ`
              });
              
              // Add first-time contributor label
              try {
                await github.rest.issues.addLabels({
                  owner, repo,
                  issue_number: pr.number,
                  labels: ['first-time-contributor']
                });
              } catch (e) {
                console.log('Could not add label');
              }
            }
