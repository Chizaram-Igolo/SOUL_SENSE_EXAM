name: Self-Assignment via Comments

on:
  issue_comment:
    types: [created]

jobs:
  process-assignment:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Process /assign command
        if: |
          !github.event.issue.pull_request &&
          (contains(github.event.comment.body, '/assign') || contains(github.event.comment.body, '/take'))
        uses: actions/github-script@v6
        with:
          script: |
            const comment = context.payload.comment;
            const issue = context.payload.issue;
            const commenter = comment.user.login;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Check if already assigned to someone else
            const currentAssignees = issue.assignees.map(a => a.login);

            if (currentAssignees.length > 0 && !currentAssignees.includes(commenter)) {
              // Issue is assigned to someone else - suggest alternatives
              const allIssues = await github.rest.issues.listForRepo({
                owner, repo,
                state: 'open',
                labels: 'status: available',
                per_page: 5
              });
              
              const alternatives = allIssues.data
                .filter(i => i.number !== issue.number)
                .slice(0, 3)
                .map(i => `#${i.number}`)
                .join(', ');
              
              const altText = alternatives ? `\n\n**Available alternatives:** ${alternatives}` : '';
              
              await github.rest.issues.createComment({
                owner, repo,
                issue_number: issue.number,
                body: `âš ï¸ **Already assigned** to @${currentAssignees[0]}.\n\nPlease check with them or pick another issue.${altText}`
              });
              
              await github.rest.reactions.createForIssueComment({
                owner, repo,
                comment_id: comment.id,
                content: 'confused'
              });
              return;
            }

            if (currentAssignees.includes(commenter)) {
              console.log(`${commenter} already assigned`);
              return;
            }

            // Workload check - count user's current assignments
            const userIssues = await github.rest.issues.listForRepo({
              owner, repo,
              state: 'open',
              assignee: commenter,
              per_page: 100
            });

            const assignedCount = userIssues.data.filter(i => !i.pull_request).length;

            if (assignedCount >= 5) {
              await github.rest.issues.createComment({
                owner, repo,
                issue_number: issue.number,
                body: `ğŸš« **Workload limit reached!** @${commenter}, you currently have **${assignedCount} issues** assigned.\n\nPlease complete some of your current work before taking new issues. This helps ensure fair distribution among all contributors.`
              });
              
              await github.rest.reactions.createForIssueComment({
                owner, repo,
                comment_id: comment.id,
                content: '-1'
              });
              return;
            }

            if (assignedCount >= 3) {
              await github.rest.issues.createComment({
                owner, repo,
                issue_number: issue.number,
                body: `âš ï¸ **Heads up!** @${commenter}, you have **${assignedCount} issues** assigned. Consider completing some before taking more.\n\n_Assigning anyway, but please be mindful of your workload._`
              });
            }

            // Assign the commenter
            await github.rest.issues.addAssignees({
              owner, repo,
              issue_number: issue.number,
              assignees: [commenter]
            });

            // Update labels
            try {
              await github.rest.issues.removeLabel({
                owner, repo,
                issue_number: issue.number,
                name: 'status: available'
              });
            } catch (e) {
              console.log('Label "status: available" not found');
            }

            await github.rest.issues.addLabels({
              owner, repo,
              issue_number: issue.number,
              labels: ['status: in-progress']
            });

            // Add success reaction and confirmation
            await github.rest.reactions.createForIssueComment({
              owner, repo,
              comment_id: comment.id,
              content: 'rocket'
            });

            await github.rest.issues.createComment({
              owner, repo,
              issue_number: issue.number,
              body: `âœ… **Assigned to @${commenter}!**\n\n**Next steps:**\n1. Fork the repo (if you haven't)\n2. Create a branch for this issue\n3. Make your changes\n4. Open a PR referencing this issue\n\nGood luck! ğŸš€`
            });

      - name: Process /unassign command
        if: |
          !github.event.issue.pull_request &&
          contains(github.event.comment.body, '/unassign')
        uses: actions/github-script@v6
        with:
          script: |
            const comment = context.payload.comment;
            const issue = context.payload.issue;
            const commenter = comment.user.login;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Check if user is actually assigned
            const currentAssignees = issue.assignees.map(a => a.login);
            if (!currentAssignees.includes(commenter)) {
              await github.rest.issues.createComment({
                owner, repo,
                issue_number: issue.number,
                body: `â„¹ï¸ @${commenter}, you are not currently assigned to this issue.`
              });
              return;
            }

            // Remove assignment
            await github.rest.issues.removeAssignees({
              owner, repo,
              issue_number: issue.number,
              assignees: [commenter]
            });

            // Update labels only if no other assignees remain
            const updatedIssue = await github.rest.issues.get({
              owner, repo,
              issue_number: issue.number
            });

            if (updatedIssue.data.assignees.length === 0) {
              try {
                await github.rest.issues.removeLabel({
                  owner, repo,
                  issue_number: issue.number,
                  name: 'status: in-progress'
                });
              } catch (e) {
                console.log('Label "status: in-progress" not found');
              }

              await github.rest.issues.addLabels({
                owner, repo,
                issue_number: issue.number,
                labels: ['status: available']
              });
            }

            await github.rest.issues.createComment({
              owner, repo,
              issue_number: issue.number,
              body: `ğŸ‘‹ @${commenter} has unassigned themselves. This issue is now available for others!`
            });

            await github.rest.reactions.createForIssueComment({
              owner, repo,
              comment_id: comment.id,
              content: '+1'
            });

      - name: Process /status command
        if: |
          !github.event.issue.pull_request &&
          contains(github.event.comment.body, '/status')
        uses: actions/github-script@v6
        with:
          script: |
            const comment = context.payload.comment;
            const commenter = comment.user.login;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get user's assigned issues
            const userIssues = await github.rest.issues.listForRepo({
              owner, repo,
              state: 'open',
              assignee: commenter,
              per_page: 20
            });

            const issues = userIssues.data.filter(i => !i.pull_request);

            if (issues.length === 0) {
              await github.rest.issues.createComment({
                owner, repo,
                issue_number: context.payload.issue.number,
                body: `ğŸ“‹ **Status for @${commenter}:**\n\nYou have **no issues** currently assigned. Use \`/assign\` on an issue to get started!`
              });
              return;
            }

            const issueList = issues.map(i => `- #${i.number}: ${i.title}`).join('\n');

            await github.rest.issues.createComment({
              owner, repo,
              issue_number: context.payload.issue.number,
              body: `ğŸ“‹ **Status for @${commenter}:**\n\n**Assigned issues (${issues.length}):**\n${issueList}\n\n_Use \`/unassign\` to release an issue._`
            });
